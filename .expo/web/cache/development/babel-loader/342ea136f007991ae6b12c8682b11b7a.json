{"ast":null,"code":"var _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports._getCurrentWatchId = _getCurrentWatchId;\nexports.HeadingSubscriber = exports.LocationSubscriber = void 0;\n\nvar _classCallCheck2 = _interopRequireDefault(require(\"@babel/runtime/helpers/classCallCheck\"));\n\nvar _createClass2 = _interopRequireDefault(require(\"@babel/runtime/helpers/createClass\"));\n\nvar _ExpoLocation = _interopRequireDefault(require(\"./ExpoLocation\"));\n\nvar _LocationEventEmitter = require(\"./LocationEventEmitter\");\n\nvar nextWatchId = 0;\n\nvar Subscriber = function () {\n  function Subscriber(eventName, eventDataField) {\n    (0, _classCallCheck2.default)(this, Subscriber);\n    this.callbacks = {};\n    this.eventSubscription = null;\n    this.eventName = eventName;\n    this.eventDataField = eventDataField;\n  }\n\n  (0, _createClass2.default)(Subscriber, [{\n    key: \"maybeInitializeSubscription\",\n    value: function maybeInitializeSubscription() {\n      var _this = this;\n\n      if (this.eventSubscription) {\n        return;\n      }\n\n      this.eventSubscription = _LocationEventEmitter.LocationEventEmitter.addListener(this.eventName, function (event) {\n        return _this.trigger(event);\n      });\n    }\n  }, {\n    key: \"registerCallback\",\n    value: function registerCallback(callback) {\n      this.maybeInitializeSubscription();\n      var id = ++nextWatchId;\n      this.callbacks[id] = callback;\n      return id;\n    }\n  }, {\n    key: \"unregisterCallback\",\n    value: function unregisterCallback(id) {\n      if (!this.callbacks[id]) {\n        return;\n      }\n\n      delete this.callbacks[id];\n\n      _ExpoLocation.default.removeWatchAsync(id);\n\n      if (Object.keys(this.callbacks).length === 0 && this.eventSubscription) {\n        _LocationEventEmitter.LocationEventEmitter.removeSubscription(this.eventSubscription);\n\n        this.eventSubscription = null;\n      }\n    }\n  }, {\n    key: \"trigger\",\n    value: function trigger(event) {\n      var watchId = event.watchId;\n      var callback = this.callbacks[watchId];\n\n      if (callback) {\n        callback(event[this.eventDataField]);\n      } else {\n        _ExpoLocation.default.removeWatchAsync(watchId);\n      }\n    }\n  }]);\n  return Subscriber;\n}();\n\nvar LocationSubscriber = new Subscriber('Expo.locationChanged', 'location');\nexports.LocationSubscriber = LocationSubscriber;\nvar HeadingSubscriber = new Subscriber('Expo.headingChanged', 'heading');\nexports.HeadingSubscriber = HeadingSubscriber;\n\nfunction _getCurrentWatchId() {\n  return nextWatchId;\n}","map":{"version":3,"sources":["../src/LocationSubscribers.ts"],"names":[],"mappings":";;;;;;;;;;;;AAEA;;AAEA;;AAOA,IAAI,WAAW,GAAG,CAAlB;;IAEM,U;AAMJ,sBAAY,SAAZ,EAA+B,cAA/B,EAAqD;AAAA;AAH7C,SAAA,SAAA,GAA4C,EAA5C;AACA,SAAA,iBAAA,GAAyC,IAAzC;AAGN,SAAK,SAAL,GAAiB,SAAjB;AACA,SAAK,cAAL,GAAsB,cAAtB;AACD;;;;kDAE0B;AAAA;;AACzB,UAAI,KAAK,iBAAT,EAA4B;AAC1B;AACD;;AACD,WAAK,iBAAL,GAAyB,2CAAqB,WAArB,CACvB,KAAK,SADkB,EAEvB,UAAC,KAAD;AAAA,eAAwB,KAAI,CAAC,OAAL,CAAa,KAAb,CAAxB;AAAA,OAFuB,CAAzB;AAID;;;qCAKgB,Q,EAAsB;AACrC,WAAK,2BAAL;AACA,UAAM,EAAE,GAAG,EAAE,WAAb;AACA,WAAK,SAAL,CAAe,EAAf,IAAqB,QAArB;AACA,aAAO,EAAP;AACD;;;uCAKkB,E,EAAU;AAE3B,UAAI,CAAC,KAAK,SAAL,CAAe,EAAf,CAAL,EAAyB;AACvB;AACD;;AAED,aAAO,KAAK,SAAL,CAAe,EAAf,CAAP;;AACA,4BAAa,gBAAb,CAA8B,EAA9B;;AAEA,UAAI,MAAM,CAAC,IAAP,CAAY,KAAK,SAAjB,EAA4B,MAA5B,KAAuC,CAAvC,IAA4C,KAAK,iBAArD,EAAwE;AACtE,mDAAqB,kBAArB,CAAwC,KAAK,iBAA7C;;AACA,aAAK,iBAAL,GAAyB,IAAzB;AACD;AACF;;;4BAEO,K,EAAkB;AACxB,UAAM,OAAO,GAAG,KAAK,CAAC,OAAtB;AACA,UAAM,QAAQ,GAAG,KAAK,SAAL,CAAe,OAAf,CAAjB;;AAEA,UAAI,QAAJ,EAAc;AACZ,QAAA,QAAQ,CAAC,KAAK,CAAC,KAAK,cAAN,CAAN,CAAR;AACD,OAFD,MAEO;AACL,8BAAa,gBAAb,CAA8B,OAA9B;AACD;AACF;;;;;AAGI,IAAM,kBAAkB,GAAG,IAAI,UAAJ,CAChC,sBADgC,EAEhC,UAFgC,CAA3B;;AAIA,IAAM,iBAAiB,GAAG,IAAI,UAAJ,CAC/B,qBAD+B,EAE/B,SAF+B,CAA1B;;;AAQD,SAAU,kBAAV,GAA4B;AAChC,SAAO,WAAP;AACD","sourcesContent":["import { Subscription } from '@unimodules/core';\n\nimport ExpoLocation from './ExpoLocation';\nimport { LocationCallback, LocationHeadingCallback } from './Location.types';\nimport { LocationEventEmitter } from './LocationEventEmitter';\n\ntype EventObject = {\n  watchId: number;\n  [key: string]: any;\n};\n\nlet nextWatchId = 0;\n\nclass Subscriber<CallbackType extends LocationCallback | LocationHeadingCallback> {\n  private eventName: string;\n  private eventDataField: string;\n  private callbacks: { [id: string]: CallbackType } = {};\n  private eventSubscription: Subscription | null = null;\n\n  constructor(eventName: string, eventDataField: string) {\n    this.eventName = eventName;\n    this.eventDataField = eventDataField;\n  }\n\n  maybeInitializeSubscription() {\n    if (this.eventSubscription) {\n      return;\n    }\n    this.eventSubscription = LocationEventEmitter.addListener(\n      this.eventName,\n      (event: EventObject) => this.trigger(event)\n    );\n  }\n\n  /**\n   * Registers given callback under new id which is then returned.\n   */\n  registerCallback(callback: CallbackType): number {\n    this.maybeInitializeSubscription();\n    const id = ++nextWatchId;\n    this.callbacks[id] = callback;\n    return id;\n  }\n\n  /**\n   * Unregisters a callback with given id and revokes the subscription if possible.\n   */\n  unregisterCallback(id: number): void {\n    // Do nothing if we have already unregistered the callback.\n    if (!this.callbacks[id]) {\n      return;\n    }\n\n    delete this.callbacks[id];\n    ExpoLocation.removeWatchAsync(id);\n\n    if (Object.keys(this.callbacks).length === 0 && this.eventSubscription) {\n      LocationEventEmitter.removeSubscription(this.eventSubscription);\n      this.eventSubscription = null;\n    }\n  }\n\n  trigger(event: EventObject): void {\n    const watchId = event.watchId;\n    const callback = this.callbacks[watchId];\n\n    if (callback) {\n      callback(event[this.eventDataField]);\n    } else {\n      ExpoLocation.removeWatchAsync(watchId);\n    }\n  }\n}\n\nexport const LocationSubscriber = new Subscriber<LocationCallback>(\n  'Expo.locationChanged',\n  'location'\n);\nexport const HeadingSubscriber = new Subscriber<LocationHeadingCallback>(\n  'Expo.headingChanged',\n  'heading'\n);\n\n/**\n * Necessary for some unit tests.\n */\nexport function _getCurrentWatchId(): number {\n  return nextWatchId;\n}\n"],"sourceRoot":""},"metadata":{},"sourceType":"script"}